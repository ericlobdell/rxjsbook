{"version":3,"sources":["js/earthquake_viz.js"],"names":[],"mappings":"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","file":"js/earthquake_viz.js","sourcesContent":["/// <reference path=\"../../Scripts/rx.dom.js\" />\r\n/// <reference path=\"../../Scripts/rx.all.js\" />\r\n/// <reference path=\"../../Scripts/leaflet/leaflet.js\" />\r\n\r\nvar QUAKE_URL = \"http://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojsonp\";\r\n\r\nvar map = L.map( 'map' ).setView( [33.858631, -118.279602], 7 );\r\nL.tileLayer( 'http://{s}.tile.osm.org/{z}/{x}/{y}.png' ).addTo( map );\r\n\r\nlet codeLayers = {};\r\nlet quakeLayer = L.layerGroup( [] ).addTo( map );\r\nlet identity = Rx.helpers.identity;\r\nlet table = document.getElementById( \"quakes-info\" );\r\n\r\nRx.DOM.ready().subscribe( init );\r\n\r\nfunction init() {\r\n    var socket = Rx.DOM.fromWebSocket( \"ws://127.0.0.1:8080\" );\r\n    var quakes = Rx.Observable\r\n    .interval( 5000 )\r\n    .flatMap(() => {\r\n        return Rx.DOM.jsonpRequest( {\r\n            url: QUAKE_URL,\r\n            jsonpCallback: 'eqfeed_callback'\r\n        } ).retry( 3 );\r\n    } )\r\n    .flatMap( data => Rx.Observable.from( data.response.features ) )\r\n    .distinct( q => q.properties.code )\r\n    .share();\r\n\r\n    quakes.subscribe( quake => {\r\n        let coords = quake.geometry.coordinates;\r\n        let size = quake.properties.mag * 10000;\r\n        let circle = L.circle( [coords[1], coords[0]], size ).addTo( map );\r\n\r\n        quakeLayer.addLayer( circle );\r\n        codeLayers[quake.id] = quakeLayer.getLayerId( circle );\r\n    } );\r\n\r\n    quakes\r\n        .pluck( \"properties\" )\r\n        .map( makeRow )\r\n        .bufferWithTime( 500 )\r\n        .filter( rows => rows.length )\r\n        .map( rows => {\r\n            let fragment = document.createDocumentFragment();\r\n\r\n            rows.forEach( row =>\r\n                fragment.appendChild( row ) );\r\n\r\n            return fragment;\r\n        } )\r\n        .subscribe( fragment => table.appendChild( fragment ) );\r\n\r\n    quakes\r\n        .bufferWithCount( 100 )\r\n        .subscribe( quakes => {\r\n            let qdata = quakes.map( q => {\r\n                return {\r\n                    id: q.properties.net + q.properties.code,\r\n                    lat: q.geometry.coordinates[1],\r\n                    lng: q.geometry.coordinates[0],\r\n                    mag: q.properties.mag\r\n                }\r\n            } );\r\n\r\n            socket.onNext( JSON.stringify( { quakes: qdata } ) );\r\n        } );\r\n\r\n    socket.subscribe( message => {\r\n        console.log( \"Server message: \", JSON.parse( message.data ) );\r\n    } )\r\n\r\n    getRowFromEvent( 'mouseover' )\r\n        .pairwise()\r\n        .subscribe( rows => {\r\n            let prevCircle = quakeLayer.getLayer( codeLayers[rows[0].id] );\r\n            let currCircle = quakeLayer.getLayer( codeLayers[rows[1].id] );\r\n\r\n            prevCircle.setStyle( { color: \"#ff0000\" } );\r\n            currCircle.setStyle( { color: \"#0000ff\" } );\r\n        } );\r\n\r\n    getRowFromEvent( 'click' )\r\n        .subscribe( row => {\r\n            let circle = quakeLayer.getLayer( codeLayers[row.id] );\r\n            map.panTo( circle.getLatLng() );\r\n        } );\r\n\r\n}\r\n\r\nfunction getRowFromEvent( event ) {\r\n    return Rx.Observable\r\n        .fromEvent( table, event )\r\n        .filter( e => e.target.tagName === 'TD' && e.target.parentNode.id.length )\r\n        .pluck( 'target', 'parentNode' )\r\n        .distinctUntilChanged()\r\n}\r\n\r\nfunction isHovering( element ) {\r\n    let over = Rx.DOM.mouseover( element ).map( identity( true ) );\r\n    let out = Rx.DOM.mouseout( element ).map( identity( true ) );\r\n\r\n    return over.merge( out );\r\n}\r\n\r\nfunction makeRow( props ) {\r\n    let row = document.createElement( \"tr\" );\r\n    row.id = props.net + props.code;\r\n\r\n    let date = new Date( props.time );\r\n    let time = date.toString();\r\n\r\n    [props.place, props.mag, time].forEach( data => {\r\n        let cell = document.createElement( \"td\" );\r\n        cell.textContent = data;\r\n        row.appendChild( cell );\r\n    } );\r\n\r\n    return row;\r\n}\r\n"],"sourceRoot":"/source/"}